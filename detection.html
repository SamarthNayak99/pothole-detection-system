<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pothole Detection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            color: #ffffff;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 700;
        }

        .section {
            background: #1a1a1a;
            border: 2px solid #333333;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .section h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #ffffff;
        }

        #videoContainer {
            max-width: 1000px;
            height: 700px;
            margin: 0 auto;
            background: #000000;
            border: 3px solid #ffffff;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: rotate(90deg);
            transform-origin: center center;
        }

        .placeholder {
            color: #666666;
            font-size: 1.25rem;
        }

        .gps-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .gps-item {
            background: #000000;
            border: 2px solid #ffffff;
            padding: 1rem;
            border-radius: 8px;
        }

        .gps-label {
            font-size: 0.875rem;
            color: #999999;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .gps-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #ffffff;
        }

        .btn {
            width: 100%;
            max-width: 400px;
            display: block;
            margin: 2rem auto;
            padding: 1.5rem 2rem;
            font-size: 1.25rem;
            font-weight: 600;
            background: #ffffff;
            color: #000000;
            border: 3px solid #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .btn:hover {
            background: #000000;
            color: #ffffff;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.2);
        }

        .status {
            text-align: center;
            font-size: 1.125rem;
            padding: 1rem;
            background: #1a1a1a;
            border: 2px solid #333333;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 1rem;
            color: #ffffff;
            text-decoration: none;
            font-size: 1rem;
            border: 2px solid #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: #ffffff;
            color: #000000;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            h1 {
                font-size: 1.75rem;
            }

            .section {
                padding: 1.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Home</a>

        <h1>üìπ Pothole Detection</h1>

        <!-- Camera Section -->
        <div class="section">
            <h2>Live Camera Feed</h2>
            <div id="videoContainer">
                <img id="video" />
                <div id="placeholder" class="placeholder">Camera will appear here</div>
            </div>
        </div>

        <!-- GPS Information -->
        <div class="glass-panel p-6 mb-8">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <span>GPS Information</span>
            </h2>
            <div class="grid grid-cols-2 gap-4">
                <!-- Latitude Box -->
                <div
                    style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                    <div
                        style="color: #aaa; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">
                        LATITUDE</div>
                    <div id="latitude"
                        style="font-family: monospace; font-size: 1.5rem; font-weight: bold; color: #60a5fa;">---</div>
                </div>
                <!-- Longitude Box -->
                <div
                    style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                    <div
                        style="color: #aaa; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">
                        LONGITUDE</div>
                    <div id="longitude"
                        style="font-family: monospace; font-size: 1.5rem; font-weight: bold; color: #4ade80;">---</div>
                </div>

                <!-- Google Maps Link -->
                <div style="margin-top: 1rem;">
                    <a id="mapsLink" href="#" target="_blank"
                        class="block w-full text-center transition-all hover:scale-105 active:scale-95" style="
                       display: flex;
                       justify-content: center;
                       align-items: center;
                       width: 100%;
                       padding: 15px;
                       background: linear-gradient(135deg, #4285F4, #34A853);
                       border: none;
                       border-radius: 8px;
                       color: white;
                       font-weight: bold;
                       font-size: 1.1rem;
                       text-decoration: none;
                       box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                       text-transform: uppercase;
                       letter-spacing: 1px;
                       text-align: center;
                   ">
                        üó∫Ô∏è Open Location in Google Maps
                    </a>
                </div>
            </div>


            <!-- Auto-Detection Controls -->
            <div class="section">
                <h2>ü§ñ Auto-Detection</h2>
                <button class="btn" id="autoDetectBtn">
                    ‚ñ∂Ô∏è Start Auto-Detection
                </button>

                <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <div style="color: #888; font-size: 0.875rem;">Status</div>
                            <div id="detectionStatus" style="color: #fff; font-size: 1.125rem; margin-top: 0.25rem;">‚è∏Ô∏è
                                Stopped</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 0.875rem;">Potholes Detected</div>
                            <div id="detectionCount" style="color: #10b981; font-size: 1.125rem; margin-top: 0.25rem;">0
                            </div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 0.875rem;">Last Detection</div>
                            <div id="lastDetection" style="color: #888; font-size: 1.125rem; margin-top: 0.25rem;">None
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status -->
            <div class="status" id="status">
                Click "Start Auto-Detection" to begin monitoring for potholes
            </div>
        </div>

        <!-- Audio element for beep sound -->
        <audio id="beepSound" preload="auto">
            <source
                src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE"
                type="audio/wav">
        </audio>

        <script>
            let currentLat = null;
            let currentLng = null;
            let currentAccuracy = null;

            // IP Webcam URL - Update this with your phone's IP address
            const IP_WEBCAM_URL = 'http://10.247.8.77:8080/video';

            // Initialize Camera with IP Webcam
            function initCamera() {
                try {
                    const video = document.getElementById('video');
                    const placeholder = document.getElementById('placeholder');

                    // Use IP webcam stream
                    video.src = IP_WEBCAM_URL;
                    video.style.display = 'block';
                    placeholder.style.display = 'none';

                    video.onerror = function () {
                        console.error('IP Webcam connection failed');
                        placeholder.style.display = 'block';
                        placeholder.textContent = 'IP Webcam connection failed. Check if IP Webcam app is running.';
                        video.style.display = 'none';
                    };

                    console.log('IP Webcam initialized:', IP_WEBCAM_URL);
                } catch (error) {
                    console.error('Camera error:', error);
                    document.getElementById('placeholder').textContent = 'Camera access error';
                }
            }

            // Fallback GPS coordinates (Current Location)
            const FALLBACK_LAT = 12.9233376;
            const FALLBACK_LNG = 77.5011285;

            // Initialize GPS
            function initGPS() {
                // DISABLED: Browser GPS detection (laptop GPS is inaccurate)
                // Using hardcoded coordinates instead

                /* 
                if (!navigator.geolocation) {
                    console.error('Geolocation not supported');
                    // Use fallback coordinates
                    currentLat = FALLBACK_LAT;
                    currentLng = FALLBACK_LNG;
                    currentAccuracy = 0;

                    document.getElementById('latitude').textContent = currentLat.toFixed(7);
                    document.getElementById('longitude').textContent = currentLng.toFixed(7);

                    // Update Map Link
                    const mapUrl = `https://www.google.com/maps?q=${currentLat},${currentLng}`;
                    const mapLink = document.getElementById('mapsLink');
                    if (mapLink) {
                        mapLink.href = mapUrl;
                        mapLink.innerHTML = `üó∫Ô∏è View on Google Maps`;
                    }
                    return;
                }

                navigator.geolocation.watchPosition(
                    (position) => {
                        currentLat = position.coords.latitude;
                        currentLng = position.coords.longitude;

                        document.getElementById('latitude').textContent = currentLat.toFixed(6);
                        document.getElementById('longitude').textContent = currentLng.toFixed(6);
                        
                        // Update Map Link
                        const mapUrl = `https://www.google.com/maps?q=${currentLat},${currentLng}`;
                        const mapLink = document.getElementById('mapsLink');
                        if (mapLink) {
                            mapLink.href = mapUrl;
                            mapLink.innerHTML = `üó∫Ô∏è View on Google Maps (${currentLat.toFixed(4)}, ${currentLng.toFixed(4)})`;
                        }

                        console.log('GPS updated:', currentLat, currentLng);
                    },
                    (error) => {
                        console.warn('GPS signal unavailable (using fallback):', error.message);

                        // Use fallback coordinates on error
                        currentLat = FALLBACK_LAT;
                        currentLng = FALLBACK_LNG;
                        currentAccuracy = 0;

                        document.getElementById('latitude').textContent = currentLat.toFixed(7);
                        document.getElementById('longitude').textContent = currentLng.toFixed(7);
                        // Accuracy display removed
                        
                        // Update Map Link (Fallback)
                        const mapUrl = `https://www.google.com/maps?q=${currentLat},${currentLng}`;
                        const mapLink = document.getElementById('mapsLink');
                        if (mapLink) {
                            mapLink.href = mapUrl;
                            mapLink.innerHTML = `üó∫Ô∏è View on Google Maps`;
                        }

                        console.log('Using fallback GPS coordinates:', currentLat, currentLng);
                    },
                    {
                        enableHighAccuracy: true,  // Try to get best possible location
                        timeout: 30000,            // Wait up to 30 seconds (was 10s)
                        maximumAge: 300000         // Reuse last known position from previous 5 mins
                    }
                );
                */

                // FORCE HARDCODED COORDINATES
                currentLat = FALLBACK_LAT;
                currentLng = FALLBACK_LNG;
                currentAccuracy = 0;

                document.getElementById('latitude').textContent = currentLat.toFixed(7);
                document.getElementById('longitude').textContent = currentLng.toFixed(7);

                // Update Map Link
                const mapUrl = `https://www.google.com/maps?q=${currentLat},${currentLng}`;
                const mapLink = document.getElementById('mapsLink');
                if (mapLink) {
                    mapLink.href = mapUrl;
                    mapLink.innerHTML = `üó∫Ô∏è View on Google Maps`;
                }

                console.log('Using fixed GPS coordinates:', currentLat, currentLng);
            }

            // Backend API URL (Render Production)
            const API_URL = 'https://pothole-detection-backend-vpmt.onrender.com';

            // Auto-Detection State
            let isDetecting = false;
            let detectionInterval = null;
            let detectionCount = 0;
            let lastDetectionTime = 0;
            const COOLDOWN_MS = 5000; // 5 seconds cooldown
            const DETECTION_INTERVAL_MS = 1000; // Check every 1 second

            // Auto-Detection Function
            async function detectPothole() {
                try {
                    // Check cooldown
                    const now = Date.now();
                    if (now - lastDetectionTime < COOLDOWN_MS) {
                        console.log('‚è≥ Cooldown active, skipping detection');
                        return;
                    }

                    // Get current GPS coordinates
                    const lat = currentLat || FALLBACK_LAT;
                    const lng = currentLng || FALLBACK_LNG;

                    // Capture frame from IP webcam using shot.jpg endpoint
                    const videoElement = document.getElementById('video');
                    if (!videoElement || !videoElement.src) {
                        console.log('‚ö†Ô∏è No video stream available');
                        return;
                    }

                    // Use shot.jpg endpoint for single frame capture
                    const shotUrl = 'http://10.247.8.77:8080/shot.jpg';
                    console.log('üì∏ Capturing frame from:', shotUrl);

                    // Fetch single frame
                    const response = await fetch(shotUrl);
                    if (!response.ok) {
                        throw new Error(`Failed to capture frame: ${response.status}`);
                    }
                    const blob = await response.blob();
                    console.log('‚úÖ Frame captured, size:', blob.size, 'bytes');

                    // Send to ML detection endpoint
                    const formData = new FormData();
                    formData.append('file', blob, 'frame.jpg');

                    const detectResponse = await fetch(`${API_URL}/detect`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!detectResponse.ok) {
                        throw new Error(`Detection failed: ${detectResponse.status}`);
                    }

                    const result = await detectResponse.json();
                    console.log('üîç Detection result:', result);

                    // If pothole detected
                    if (result.detected && result.confidence >= 0.5) {
                        console.log(`‚úÖ POTHOLE DETECTED! Confidence: ${(result.confidence * 100).toFixed(1)}%`);

                        // Play beep sound
                        const beep = document.getElementById('beepSound');
                        beep.play().catch(e => console.log('Could not play sound:', e));

                        // Save to backend
                        const potholeData = {
                            latitude: lat,
                            longitude: lng,
                            timestamp: new Date().toISOString(),
                            confidence: result.confidence,
                            image_path: result.image_path // Use full relative path for backend to find it
                        };

                        const saveResponse = await fetch(`${API_URL}/potholes`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(potholeData)
                        });

                        if (saveResponse.ok) {
                            const savedPothole = await saveResponse.json();

                            // Update UI
                            detectionCount++;
                            document.getElementById('detectionCount').textContent = detectionCount;
                            document.getElementById('lastDetection').textContent =
                                `#${savedPothole.id} (${(result.confidence * 100).toFixed(1)}%)`;
                            document.getElementById('status').textContent =
                                `üéØ Pothole #${savedPothole.id} detected and saved! Confidence: ${(result.confidence * 100).toFixed(1)}%`;
                            document.getElementById('status').style.color = '#10b981';

                            // Set cooldown
                            lastDetectionTime = now;
                            console.log(`‚úÖ Pothole #${savedPothole.id} saved, cooldown active for 5 seconds`);
                        }
                    } else {
                        // No pothole detected
                        document.getElementById('status').textContent = 'üîç Monitoring... No pothole detected';
                        document.getElementById('status').style.color = '#888';
                    }

                } catch (error) {
                    console.error('‚ùå Detection error:', error);
                    document.getElementById('status').textContent = `‚ö†Ô∏è Detection error: ${error.message}`;
                    document.getElementById('status').style.color = '#ef4444';
                }
            }

            // Start/Stop Auto-Detection
            document.getElementById('autoDetectBtn').addEventListener('click', () => {
                if (isDetecting) {
                    // Stop detection
                    isDetecting = false;
                    clearInterval(detectionInterval);
                    detectionInterval = null;

                    document.getElementById('autoDetectBtn').innerHTML = '‚ñ∂Ô∏è Start Auto-Detection';
                    document.getElementById('detectionStatus').textContent = '‚è∏Ô∏è Stopped';
                    document.getElementById('status').textContent = 'Auto-detection stopped';
                    document.getElementById('status').style.color = '#888';

                    console.log('üõë Auto-detection stopped');
                } else {
                    // Start detection
                    isDetecting = true;
                    detectionInterval = setInterval(detectPothole, DETECTION_INTERVAL_MS);

                    document.getElementById('autoDetectBtn').innerHTML = '‚è∏Ô∏è Stop Auto-Detection';
                    document.getElementById('detectionStatus').textContent = 'üîç Monitoring...';
                    document.getElementById('status').textContent = 'üîç Auto-detection started - monitoring for potholes every 1 second';
                    document.getElementById('status').style.color = '#10b981';

                    console.log('‚ñ∂Ô∏è Auto-detection started');

                    // Run first detection immediately
                    detectPothole();
                }
            });

            // Initialize on page load
            window.addEventListener('load', () => {
                initCamera();
                initGPS();
            });
        </script>
</body>

</html>