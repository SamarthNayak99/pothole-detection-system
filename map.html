<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <title>Pothole Map - Detector</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            /* Light mode */
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --header-bg: rgba(0, 0, 0, 0.3);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: rgba(0, 0, 0, 0.1);
            --popup-bg: #ffffff;
        }

        body.dark-mode {
            /* Dark mode */
            --bg-gradient-start: #1e1b4b;
            --bg-gradient-end: #312e81;
            --header-bg: rgba(0, 0, 0, 0.5);
            --card-bg: rgba(30, 27, 75, 0.95);
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: rgba(255, 255, 255, 0.1);
            --popup-bg: #1e1b4b;
        }

        /* Dark mode map tiles invert */
        body.dark-mode .leaflet-tile-pane {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #667eea;
            overflow: hidden;
            transition: background 0.3s ease;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 70px;
            right: 15px;
            z-index: 1001;
            display: flex;
            gap: 6px;
            background: var(--card-bg);
            padding: 6px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .theme-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: white;
            font-size: 20px;
            font-weight: 600;
        }

        .stats-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        /* Map Container */
        #map {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 70px;
            z-index: 1;
        }

        /* Control Panel */
        .control-panel {
            position: fixed;
            bottom: 80px;
            left: 10px;
            right: 10px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 8px;
            overflow-x: auto;
            transition: background 0.3s ease;
        }

        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #1f2937;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid var(--border-color);
            z-index: 1000;
            transition: background 0.3s ease;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 12px;
            transition: color 0.3s;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-icon {
            font-size: 24px;
            display: block;
            margin-bottom: 4px;
        }

        /* Custom Marker Popup */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
            background: var(--popup-bg);
            color: var(--text-primary);
        }

        .leaflet-popup-tip {
            background: var(--popup-bg);
        }

        .popup-content {
            padding: 15px;
            min-width: 250px;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .popup-id {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .popup-confidence {
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .conf-high {
            background: #dcfce7;
            color: #166534;
        }

        .conf-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .conf-low {
            background: #fee2e2;
            color: #991b1b;
        }

        .popup-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .popup-details {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .popup-actions {
            display: flex;
            gap: 8px;
        }

        .popup-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            z-index: 2000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 2000;
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>

<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <button class="theme-btn active" id="light-btn" onclick="setTheme('light')" title="Light Mode">
            ‚òÄÔ∏è
        </button>
        <button class="theme-btn" id="dark-btn" onclick="setTheme('dark')" title="Dark Mode">
            üåô
        </button>
    </div>

    <!-- Header -->
    <div class="header">
        <h1>üó∫Ô∏è Pothole Map</h1>
        <div class="stats-badge" id="stats-badge">0 Potholes</div>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Control Panel -->
    <div class="control-panel">
        <button class="control-btn btn-primary" onclick="centerMap()">üìç My Location</button>
        <button class="control-btn btn-secondary" onclick="fitAllMarkers()">üîç Fit All</button>
        <button class="control-btn btn-success" onclick="refreshMap()">üîÑ Refresh</button>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="home.html" class="nav-item">
            <span class="nav-icon">üè†</span>
            Home
        </a>
        <a href="mobile-detect.html" class="nav-item">
            <span class="nav-icon">üìπ</span>
            Detect
        </a>
        <a href="history.html" class="nav-item">
            <span class="nav-icon">üìä</span>
            History
        </a>
        <a href="map.html" class="nav-item active">
            <span class="nav-icon">üó∫Ô∏è</span>
            Map
        </a>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Loading map...</div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        const API_URL = 'https://pothole-detection-backend-vpmt.onrender.com';
        let map;
        let markers = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        });
        let potholes = [];
        let userLocation = null;

        // Initialize map
        function initMap() {
            // Create map centered on Bangalore (default)
            map = L.map('map').setView([12.9716, 77.5946], 12);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Add marker cluster group
            map.addLayer(markers);

            // Try to get user location
            getUserLocation();

            // Load potholes
            loadPotholes();

            // Hide loading
            document.getElementById('loading').style.display = 'none';
        }

        // Get user's current location
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = [position.coords.latitude, position.coords.longitude];
                        map.setView(userLocation, 14);

                        // Add user location marker
                        L.marker(userLocation, {
                            icon: L.divIcon({
                                className: 'user-location-marker',
                                html: 'üìç',
                                iconSize: [30, 30]
                            })
                        }).addTo(map).bindPopup('Your Location');

                        showToast('Location found!');
                    },
                    (error) => {
                        console.log('Location error:', error);
                        showToast('Using default location');
                    }
                );
            }
        }

        // Load potholes from backend
        async function loadPotholes() {
            try {
                const response = await fetch(`${API_URL}/potholes`);
                if (!response.ok) throw new Error('Failed to load potholes');

                potholes = await response.json();
                console.log(`Loaded ${potholes.length} potholes`);

                // Update stats
                document.getElementById('stats-badge').textContent = `${potholes.length} Potholes`;

                // Clear existing markers
                markers.clearLayers();

                // Add markers for each pothole
                potholes.forEach(pothole => {
                    addPotholeMarker(pothole);
                });

                showToast(`Loaded ${potholes.length} potholes`);
            } catch (error) {
                console.error('Error loading potholes:', error);
                showToast('Failed to load potholes', 'error');
            }
        }

        // Add pothole marker to map
        function addPotholeMarker(pothole) {
            const confidence = (pothole.confidence || 0) * 100;
            const confClass = confidence >= 75 ? 'conf-high'
                : confidence >= 50 ? 'conf-medium'
                    : 'conf-low';

            // Create custom icon
            const icon = L.divIcon({
                className: 'pothole-marker',
                html: `<div style="background: #ef4444; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">üï≥Ô∏è</div>`,
                iconSize: [30, 30]
            });

            // Create marker
            const marker = L.marker([pothole.latitude, pothole.longitude], { icon });

            // Create popup content
            const imagePath = pothole.image_path
                ? `${API_URL}/${pothole.image_path}`
                : null;

            const popupContent = `
                <div class="popup-content">
                    <div class="popup-header">
                        <div class="popup-id">üö® Pothole #${pothole.id}</div>
                        <div class="popup-confidence ${confClass}">${confidence.toFixed(1)}%</div>
                    </div>
                    ${imagePath
                    ? `<img src="${imagePath}" class="popup-image" onerror="this.style.display='none'">`
                    : ''}
                    <div class="popup-details">
                        üìç ${pothole.latitude.toFixed(6)}, ${pothole.longitude.toFixed(6)}<br>
                        üìÖ ${new Date(pothole.timestamp).toLocaleString()}
                    </div>
                    <div class="popup-actions">
                        <button class="popup-btn btn-primary" onclick="openInGoogleMaps(${pothole.latitude}, ${pothole.longitude})">
                            Navigate
                        </button>
                        <button class="popup-btn btn-secondary" onclick="shareLocation(${pothole.id}, ${pothole.latitude}, ${pothole.longitude})">
                            Share
                        </button>
                        <button class="popup-btn btn-danger" onclick="deletePotholeFromMap(${pothole.id})">
                            Delete
                        </button>
                    </div>
                </div>
            `;

            marker.bindPopup(popupContent, {
                maxWidth: 300,
                className: 'custom-popup'
            });

            // Add to cluster group
            markers.addLayer(marker);
        }

        // Center map on user location
        function centerMap() {
            if (userLocation) {
                map.setView(userLocation, 15);
                showToast('Centered on your location');
            } else {
                getUserLocation();
            }
        }

        // Fit all markers in view
        function fitAllMarkers() {
            if (potholes.length > 0) {
                const bounds = markers.getBounds();
                map.fitBounds(bounds, { padding: [50, 50] });
                showToast('Showing all potholes');
            } else {
                showToast('No potholes to show');
            }
        }

        // Refresh map data
        async function refreshMap() {
            showToast('Refreshing...');
            await loadPotholes();
        }

        // Open in Google Maps
        function openInGoogleMaps(lat, lng) {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
        }

        // Share location
        async function shareLocation(id, lat, lng) {
            const text = `Pothole #${id} at ${lat}, ${lng}\nhttps://www.google.com/maps?q=${lat},${lng}`;

            if (navigator.share) {
                try {
                    await navigator.share({ text });
                    showToast('Shared!');
                } catch (err) {
                    copyToClipboard(text);
                }
            } else {
                copyToClipboard(text);
            }
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!');
            }).catch(() => {
                showToast('Failed to copy');
            });
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Delete pothole from map
        async function deletePotholeFromMap(id) {
            if (!confirm(`Are you sure you want to permanently delete Pothole #${id}?`)) {
                return;
            }

            try {
                showToast('Deleting...');

                const response = await fetch(`${API_URL}/potholes/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete pothole');
                }

                const result = await response.json();
                showToast(`Pothole #${id} deleted!`);

                // Close any open popups
                map.closePopup();

                // Reload potholes
                await loadPotholes();

            } catch (error) {
                console.error('Error deleting pothole:', error);
                showToast('Failed to delete pothole');
            }
        }

        // Initialize on load
        window.addEventListener('load', initMap);

        // Auto-refresh every 30 seconds
        // Auto-refresh every 30 seconds
        setInterval(loadPotholes, 30000);
    </script>

    <script>
        // Theme switching functionality (synced)
        function setTheme(theme) {
            const body = document.body;
            const lightBtn = document.getElementById('light-btn');
            const darkBtn = document.getElementById('dark-btn');

            if (theme === 'dark') {
                body.classList.add('dark-mode');
                lightBtn.classList.remove('active');
                darkBtn.classList.add('active');
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark-mode');
                darkBtn.classList.remove('active');
                lightBtn.classList.add('active');
                localStorage.setItem('theme', 'light');
            }
        }

        // Load saved theme on page load
        window.addEventListener('load', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        });
    </script>
</body>

</html>